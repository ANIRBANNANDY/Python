<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enterprise Process Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-fluid py-5 px-4">
        <div class="row">
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-end mb-4">
                    <div>
                        <h2 class="fw-bold mb-0">Multi-Server Monitor</h2>
                        <p class="text-muted mb-0">User: <span class="badge bg-info text-dark">{{ config.target_user }}</span></p>
                    </div>
                    <div class="text-end">
                        <div id="last-update" class="refresh-text mb-2">Initializing...</div>
                        <button class="btn btn-primary shadow-sm" onclick="loadData()">Refresh All</button>
                    </div>
                </div>
                
                <div class="card shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Server</th>
                                    <th>Processing File</th>
                                    <th>Status</th>
                                    <th class="text-end pe-4">Control</th>
                                </tr>
                            </thead>
                            <tbody id="main-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm explorer-card">
                    <div class="explorer-header">
                        Server Explorer
                    </div>
                    <div class="p-3">
                        <label class="form-label small fw-bold">Select Server to View Folders:</label>
                        <select id="serverSelect" class="form-select mb-3" onchange="fetchFolders(this.value)">
                            <option value="">-- Select a Server --</option>
                            {% for ip in config.servers %}
                            <option value="{{ ip }}">{{ ip }}</option>
                            {% endfor %}
                        </select>
                        
                        <div id="folder-container">
                            <ul class="folder-list" id="folder-list">
                                <li class="text-muted p-3">Select a server to view the secondary directory.</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card shadow-sm queue-card">
    <div class="explorer-header d-flex justify-content-between align-items-center">
        <span>Server 1: File Queue</span>
        <span class="badge bg-purple" style="background-color: #6f42c1;">Live</span>
    </div>
    <div class="p-3">
        <div id="queue-container">
            <table class="table table-sm small">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="queue-list">
                    <tr><td colspan="2" class="text-center">Loading queue...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
            </div>
        </div>
    </div>

    <script>
        const config = {{ config|tojson }};

        // Existing Load Data Function for the Table
        async function loadData() {
            const table = document.getElementById('main-table');
            table.style.opacity = '0.5';
            let html = '';
            for (let ip of config.servers) {
                try {
                    const res = await fetch(`http://${ip}:${config.agent_port}/scan`);
                    const data = await res.json();
                    data.files.forEach(f => {
                        const statusClass = f.status === 'Processing' ? 'status-processing' : 'status-idle';
                        html += `<tr>
                            <td><span class="server-badge">${ip}</span></td>
                            <td><code>${f.name}</code></td>
                            <td><span class="${statusClass} text-uppercase" style="font-size: 0.8rem;">‚óè ${f.status}</span></td>
                            <td class="text-end pe-4">
                                <button class="btn btn-outline-danger btn-sm" onclick="killFile(this, '${ip}', '${f.name}')">Stop & Delete</button>
                            </td>
                        </tr>`;
                    });
                } catch (e) {
                    html += `<tr class="table-danger"><td>${ip}</td><td colspan="3">Offline</td></tr>`;
                }
            }
            table.innerHTML = html;
            table.style.opacity = '1';
            document.getElementById('last-update').innerText = "Last Checked: " + new Date().toLocaleTimeString();
        }

        // NEW: Fetch folders for the right-side box
        async function fetchFolders(ip) {
            if (!ip) return;
            const list = document.getElementById('folder-list');
            list.innerHTML = '<li class="p-3">Loading folders...</li>';
            
            try {
                const res = await fetch(`http://${ip}:${config.agent_port}/folders`);
                const data = await res.json();
                
                let html = '';
                if (data.folders.length === 0) {
                    html = '<li class="p-3 text-muted">No folders found in this directory.</li>';
                } else {
                    data.folders.forEach(folder => {
                        html += `<li class="folder-item">${folder}</li>`;
                    });
                }
                list.innerHTML = html;
            } catch (e) {
                list.innerHTML = '<li class="p-3 text-danger">Error connecting to server.</li>';
            }
        }

        async function killFile(btn, ip, filename) {
            if (!confirm(`Kill Perl/SAS and delete ${filename}?`)) return;
            btn.disabled = true;
            btn.innerHTML = 'Killing...';
            try {
                await fetch(`http://${ip}:${config.agent_port}/kill-delete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename: filename})
                });
                loadData();
            } catch (e) { alert("Error"); btn.disabled = false; }
        }

        // NEW: Function to specifically monitor Server 1's folder
    async function updateQueue() {
        const server1Ip = config.servers[0]; // Assumes first IP in config is Server 1
        const queueList = document.getElementById('queue-list');
        
        try {
            const res = await fetch(`http://${server1Ip}:${config.agent_port}/scan`);
            const data = await res.json();
            
            let html = '';
            if (data.files.length === 0) {
                html = '<tr><td colspan="2" class="text-center text-muted">No files in queue</td></tr>';
            } else {
                data.files.forEach(file => {
                    const statusBadge = file.status === 'Processing' 
                        ? '<span class="badge badge-active text-dark">Processing</span>' 
                        : '<span class="badge badge-pending">Pending / Idle</span>';
                    
                    html += `
                        <tr>
                            <td><code>${file.name}</code></td>
                            <td>${statusBadge}</td>
                        </tr>`;
                });
            }
            queueList.innerHTML = html;
        } catch (e) {
            queueList.innerHTML = '<tr><td colspan="2" class="text-danger">Failed to sync queue</td></tr>';
        }
    }

    // Update the window.onload and intervals
    const originalLoadData = loadData;
    loadData = async function() {
        await originalLoadData();
        await updateQueue();
    }

    // Refresh queue more frequently than the 15-min global refresh
    setInterval(updateQueue, 30000); // Check Queue every 30 seconds
    window.onload = loadData;
</script>
</body>
</html>
