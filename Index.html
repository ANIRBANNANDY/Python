<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enterprise Process Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-fluid py-5 px-4">
        <div class="row">
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-end mb-4">
                    <div>
                        <h2 class="fw-bold mb-0">Multi-Server Monitor</h2>
                        <p class="text-muted mb-0">User: <span class="badge bg-info text-dark">{{ config.target_user }}</span></p>
                    </div>
                    <div class="text-end">
                        <div id="last-update" class="refresh-text mb-2">Initializing...</div>
                        <button class="btn btn-primary shadow-sm" onclick="loadData()">Refresh All</button>
                    </div>
                </div>
                
                <div class="card shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Server</th>
                                    <th>Processing File</th>
                                    <th>Status</th>
                                    <th class="text-end pe-4">Control</th>
                                </tr>
                            </thead>
                            <tbody id="main-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm explorer-card">
                    <div class="explorer-header">
                        Server Explorer
                    </div>
                    <div class="p-3">
                        <label class="form-label small fw-bold">Select Server to View Folders:</label>
                        <select id="serverSelect" class="form-select mb-3" onchange="fetchFolders(this.value)">
                            <option value="">-- Select a Server --</option>
                            {% for ip in config.servers %}
                            <option value="{{ ip }}">{{ ip }}</option>
                            {% endfor %}
                        </select>
                        
                        <div id="folder-container">
                            <ul class="folder-list" id="folder-list">
                                <li class="text-muted p-3">Select a server to view the secondary directory.</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card shadow-sm queue-card">
    <div class="explorer-header d-flex justify-content-between align-items-center">
        <span>Server 1: File Queue</span>
        <span class="badge bg-purple" style="background-color: #6f42c1;">Live</span>
    </div>
    <div class="p-3">
        <div id="queue-container">
            <table class="table table-sm small">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="queue-list">
                    <tr><td colspan="2" class="text-center">Loading queue...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
            </div>
        </div>
    </div>

    <script>
        const config = {{ config|tojson }};

        // Existing Load Data Function for the Table
        async function loadData() {
            const table = document.getElementById('main-table');
            table.style.opacity = '0.5';
            let html = '';
            for (let ip of config.servers) {
                try {
                    const res = await fetch(`http://${ip}:${config.agent_port}/scan`);
                    const data = await res.json();
                    data.files.forEach(f => {
                        const statusClass = f.status === 'Processing' ? 'status-processing' : 'status-idle';
                        html += `<tr>
                            <td><span class="server-badge">${ip}</span></td>
                            <td><code>${f.name}</code></td>
                            <td><span class="${statusClass} text-uppercase" style="font-size: 0.8rem;">‚óè ${f.status}</span></td>
                            <td class="text-end pe-4">
                                <button class="btn btn-outline-danger btn-sm" onclick="killFile(this, '${ip}', '${f.name}')">Stop & Delete</button>
                            </td>
                        </tr>`;
                    });
                } catch (e) {
                    html += `<tr class="table-danger"><td>${ip}</td><td colspan="3">Offline</td></tr>`;
                }
            }
            table.innerHTML = html;
            table.style.opacity = '1';
            document.getElementById('last-update').innerText = "Last Checked: " + new Date().toLocaleTimeString();
        }

        // NEW: Fetch folders for the right-side box
        async function fetchFolders(ip) {
            if (!ip) return;
            const list = document.getElementById('folder-list');
            list.innerHTML = '<li class="p-3">Loading folders...</li>';
            
            try {
                const res = await fetch(`http://${ip}:${config.agent_port}/folders`);
                const data = await res.json();
                
                let html = '';
                if (data.folders.length === 0) {
                    html = '<li class="p-3 text-muted">No folders found in this directory.</li>';
                } else {
                    data.folders.forEach(folder => {
                        html += `<li class="folder-item">${folder}</li>`;
                    });
                }
                list.innerHTML = html;
            } catch (e) {
                list.innerHTML = '<li class="p-3 text-danger">Error connecting to server.</li>';
            }
        }

        async function killFile(btn, ip, filename) {
            if (!confirm(`Kill Perl/SAS and delete ${filename}?`)) return;
            btn.disabled = true;
            btn.innerHTML = 'Killing...';
            try {
                await fetch(`http://${ip}:${config.agent_port}/kill-delete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename: filename})
                });
                loadData();
            } catch (e) { alert("Error"); btn.disabled = false; }
        }

        // NEW: Function to specifically monitor Server 1's folder
    async function updateQueue() {
        const server1Ip = config.servers[0]; // Assumes first IP in config is Server 1
        const queueList = document.getElementById('queue-list');
        
        try {
            const res = await fetch(`http://${server1Ip}:${config.agent_port}/scan`);
            const data = await res.json();
            
            let html = '';
            if (data.files.length === 0) {
                html = '<tr><td colspan="2" class="text-center text-muted">No files in queue</td></tr>';
            } else {
                data.files.forEach(file => {
                    const statusBadge = file.status === 'Processing' 
                        ? '<span class="badge badge-active text-dark">Processing</span>' 
                        : '<span class="badge badge-pending">Pending / Idle</span>';
                    
                    html += `
                        <tr>
                            <td><code>${file.name}</code></td>
                            <td>${statusBadge}</td>
                        </tr>`;
                });
            }
            queueList.innerHTML = html;
        } catch (e) {
            queueList.innerHTML = '<tr><td colspan="2" class="text-danger">Failed to sync queue</td></tr>';
        }
    }

    // Update the window.onload and intervals
    const originalLoadData = loadData;
    loadData = async function() {
        await originalLoadData();
        await updateQueue();
    }

    // Refresh queue more frequently than the 15-min global refresh
    setInterval(updateQueue, 30000); // Check Queue every 30 seconds
    window.onload = loadData;
</script>
</body>
</html>

<div class="card shadow-sm log-card mt-4">
    <div class="explorer-header d-flex justify-content-between">
        <span>Live Log Viewer: <span id="log-file-name" class="text-primary">None Selected</span></span>
        <small id="log-folder-path" class="text-muted"></small>
    </div>
    <div class="p-3">
        <div id="log-content" class="log-viewer">Select a processing row to view proglogs.txt...</div>
        <div class="mt-2 text-end">
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshSelectedLog()">Refresh Log</button>
        </div>
    </div>
</div>

<script>
    let selectedFile = null;
    let selectedIp = null;

    // Modified loadData to keep selection after refresh
    async function loadData() {
        // ... (existing fetch logic) ...
        // Add this inside your data.files.forEach:
        /*
        html += `<tr onclick="selectRow(this, '${ip}', '${f.name}')" class="${(selectedFile === f.name && selectedIp === ip) ? 'selected-row' : ''}">
                    ...
                </tr>`;
        */
    }

    async function selectRow(rowElement, ip, filename) {
        // Clear previous selection styling
        document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
        rowElement.classList.add('selected-row');

        selectedFile = filename;
        selectedIp = ip;
        document.getElementById('log-file-name').innerText = filename;
        
        fetchLog();
    }

    async function fetchLog() {
        if (!selectedFile || !selectedIp) return;
        const logBox = document.getElementById('log-content');
        
        try {
            const res = await fetch(`http://${selectedIp}:${config.agent_port}/get-log`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ filename: selectedFile })
            });
            const data = await res.json();
            
            logBox.innerText = data.log;
            if(data.folder) document.getElementById('log-folder-path').innerText = "Folder: " + data.folder;
            
            // Auto-scroll to bottom
            logBox.scrollTop = logBox.scrollHeight;
        } catch (e) {
            logBox.innerText = "Error fetching log from server.";
        }
    }

    function refreshSelectedLog() {
        fetchLog();
    }

    // Optional: Refresh log every 5 seconds if a row is selected
    setInterval(() => {
        if(selectedFile) fetchLog();
    }, 5000);
            </script>

<div class="card shadow-sm queue-card mt-3">
    <div class="explorer-header d-flex justify-content-between align-items-center bg-light">
        <span class="fw-bold">Queue Manager (Server 1)</span>
        <button class="btn btn-sm btn-link p-0" onclick="updateQueue()">üîÑ</button>
    </div>
    <div class="p-2">
        <div id="queue-container" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-sm table-borderless small mb-0">
                <tbody id="queue-list">
                    <tr><td class="text-center py-3">Loading queue files...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Fetch files from the independent Queue folder on Server 1
    async function updateQueue() {
        const server1Ip = config.servers[0]; 
        const queueList = document.getElementById('queue-list');
        
        try {
            const res = await fetch(`http://${server1Ip}:${config.agent_port}/get-queue`);
            const data = await res.json();
            
            let html = '';
            if (data.files.length === 0) {
                html = '<tr><td class="text-center text-muted py-3">Queue is empty</td></tr>';
            } else {
                data.files.forEach(file => {
                    html += `
                        <tr class="border-bottom">
                            <td class="align-middle"><code>${file.name}</code></td>
                            <td class="text-end">
                                <button class="btn btn-link text-danger btn-sm p-0 fw-bold" 
                                        style="text-decoration:none"
                                        onclick="confirmQueueDelete('${file.name}')">
                                    [ Delete ]
                                </button>
                            </td>
                        </tr>`;
                });
            }
            queueList.innerHTML = html;
        } catch (e) {
            queueList.innerHTML = '<tr><td class="text-danger text-center">Connection error</td></tr>';
        }
    }

    async function confirmQueueDelete(filename) {
        if (!confirm(`Are you sure you want to permanently delete ${filename} from the queue folder?`)) return;
        
        const server1Ip = config.servers[0];
        try {
            const res = await fetch(`http://${server1Ip}:${config.agent_port}/delete-from-queue`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ filename: filename })
            });
            
            if (res.ok) {
                updateQueue(); // Refresh list immediately
            } else {
                alert("Could not delete file. It might be in use.");
            }
        } catch (e) {
            alert("Network error.");
        }
    }

    // Initialize
    window.onload = () => {
        loadData();    // Process monitor
        updateQueue(); // Queue folder monitor
    };
    
    // Refresh the queue every 60 seconds
    setInterval(updateQueue, 60000);
</script>

<script>
    // ... (keep existing variables)

    async function fetchFolders(ip) {
        if (!ip) return;
        selectedIp = ip; // Set global IP so log viewer knows which server to talk to
        const list = document.getElementById('folder-list');
        list.innerHTML = '<li class="p-3 text-center"><div class="spinner-border spinner-border-sm"></div></li>';
        
        try {
            const res = await fetch(`http://${ip}:${config.agent_port}/folders`);
            const data = await res.json();
            
            let html = '';
            if (data.folders.length === 0) {
                html = '<li class="p-3 text-muted">No folders found.</li>';
            } else {
                data.folders.forEach(folder => {
                    html += `
                        <li class="folder-item px-3 py-2 border-bottom" id="folder-${folder}">
                            <span class="folder-name" onclick="viewFolderLog('${folder}')">üìÅ ${folder}</span>
                            <span class="btn-delete-folder" onclick="confirmFolderDelete(event, '${folder}')">Delete</span>
                        </li>`;
                });
            }
            list.innerHTML = html;
        } catch (e) {
            list.innerHTML = '<li class="p-3 text-danger">Server connection failed.</li>';
        }
    }

    async function viewFolderLog(folderName) {
        // Update UI selection
        document.querySelectorAll('.folder-item').forEach(el => el.classList.remove('selected-folder'));
        document.getElementById(`folder-${folderName}`).classList.add('selected-folder');

        const logBox = document.getElementById('log-content');
        document.getElementById('log-file-name').innerText = folderName;
        logBox.innerText = "Loading log from folder...";
        
        try {
            const res = await fetch(`http://${selectedIp}:${config.agent_port}/get-log-from-folder`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ folder_name: folderName })
            });
            const data = await res.json();
            logBox.innerText = data.log;
            logBox.scrollTop = logBox.scrollHeight;
        } catch (e) {
            logBox.innerText = "Error loading log.";
        }
    }

    async function confirmFolderDelete(event, folderName) {
        event.stopPropagation(); // Prevent triggering the log view
        if (!confirm(`Permanently delete folder "${folderName}" and all its contents?`)) return;

        try {
            const res = await fetch(`http://${selectedIp}:${config.agent_port}/delete-folder`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ folder_name: folderName })
            });
            if (res.ok) {
                fetchFolders(selectedIp); // Refresh list
                document.getElementById('log-content').innerText = "Folder deleted.";
            }
        } catch (e) {
            alert("Delete failed.");
        }
    }
</script>

<div class="card shadow-sm disk-card">
    <div class="explorer-header d-flex justify-content-between align-items-center bg-light">
        <span class="fw-bold">Disk Health: <span id="health-server-name" class="text-muted">None</span></span>
    </div>
    <div class="p-3" id="disk-container">
        <div class="text-center text-muted small">Select a server in the explorer to see disk space.</div>
    </div>
</div>

<script>
    // Extend your existing fetchFolders function to also update Disk Health
    const originalFetchFolders = fetchFolders;
    fetchFolders = async function(ip) {
        await originalFetchFolders(ip);
        if (ip) updateDiskHealth(ip);
    };

    async function updateDiskHealth(ip) {
        const container = document.getElementById('disk-container');
        document.getElementById('health-server-name').innerText = ip;
        
        try {
            const res = await fetch(`http://${ip}:${config.agent_port}/disk-usage`);
            const data = await res.json();
            
            let html = '';
            for (const [drive, stats] of Object.entries(data)) {
                if (!stats) continue;
                
                // Color logic: Red if > 90% full
                const barColor = stats.percent > 90 ? 'bg-danger' : 'bg-success';
                const percentText = stats.percent > 90 ? 'text-danger-bold' : '';

                html += `
                    <div class="mb-3">
                        <div class="disk-label mb-1">
                            <span>Drive ${drive}</span>
                            <span class="${percentText}">${stats.percent}% Full</span>
                        </div>
                        <div class="progress mb-1">
                            <div class="progress-bar ${barColor}" role="progressbar" style="width: ${stats.percent}%"></div>
                        </div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            ${stats.free} GB free of ${stats.total} GB
                        </div>
                    </div>`;
            }
            container.innerHTML = html || '<div class="text-center">No drives found.</div>';
        } catch (e) {
            container.innerHTML = '<div class="text-danger text-center">Failed to fetch disk stats.</div>';
        }
    }
</script>
