{
  "hub_port": 8080,
  "auth_api_url": "http://your-internal-api.com/whoami",
  "ad_groups": ["GG_App_Admins", "GG_App_Users"],
  "servers": ["xyzd4.abc.com", "xyzd5.abc.com", "xyzd6.abc.com"]
}

import json
import subprocess
import sys
from flask import Flask, render_template, request, jsonify

app = Flask(__name__)

def load_config():
    with open('config.json', 'r') as f:
        return json.load(f)

def check_ad_access_by_email(email):
    config = load_config()
    groups = config['ad_groups']
    groups_str = "'" + "','".join(groups) + "'"
    
    # PowerShell: Find user by email and check if they are in the groups
    ps_cmd = f"""
    $auth = $false
    $user = Get-ADUser -Filter "EmailAddress -eq '{email}'" -Properties memberOf
    if ($user) {{
        foreach ($g in @({groups_str})) {{
            if ($user.memberOf -like "*$g*") {{
                $auth = $true; break
            }}
        }}
    }}
    if ($auth) {{ "Authorized" }} else {{ "Denied" }}
    """
    try:
        res = subprocess.run(["powershell", "-Command", ps_cmd], capture_output=True, text=True)
        return "Authorized" in res.stdout
    except Exception as e:
        print(f"PS Error: {e}")
        return False

@app.route('/')
def index():
    # Pass the API URL from config to the frontend template
    config = load_config()
    host_display = sys.argv[1] if len(sys.argv) > 1 else "Hub-Server"
    return render_template('index.html', 
                           auth_url=config['auth_api_url'], 
                           host_display=host_display)

@app.route('/verify-identity', methods=['POST'])
def verify_identity():
    data = request.json
    email = data.get('email')
    
    if not email:
        return jsonify({"success": False, "message": "No identity provided"}), 400

    if check_ad_access_by_email(email):
        return jsonify({"success": True, "user": email})
    else:
        return jsonify({"success": False, "message": "User not in authorized AD group"}), 403

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)




<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Process Monitor Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #mainContent { display: none; } /* Hidden until authorized */
        #loader { display: flex; justify-content: center; align-items: center; height: 100vh; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-border text-primary" role="status"></div>
        <span class="ms-3">Verifying Identity...</span>
    </div>

    <div id="mainContent">
        <nav class="navbar navbar-dark bg-dark px-3 mb-4 shadow">
            <span class="navbar-brand fw-bold">Monitor: {{ host_display }}</span>
            <div class="ms-auto text-white">
                <small class="text-white-50">User:</small> 
                <strong id="userEmailDisplay"></strong>
            </div>
        </nav>

        <div class="container">
            <h3>Authorized Dashboard</h3>
            <p>Welcome to the process monitor.</p>
        </div>
    </div>

    <script>
        async function runAuth() {
            const authApiUrl = "{{ auth_url }}"; // Loaded from hub.py -> config.json
            
            try {
                // 1. Get identity from client-side accessible API
                const idResponse = await fetch(authApiUrl);
                const identity = await idResponse.json();
                const email = identity.email; // Adjust key if your API uses 'mail' or 'UserEmail'

                // 2. Verify against Hub's AD check
                const verifyResponse = await fetch('/verify-identity', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: email })
                });

                const result = await verifyResponse.json();

                if (result.success) {
                    document.getElementById('userEmailDisplay').innerText = result.user;
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    showError("Access Denied: " + result.message);
                }
            } catch (err) {
                showError("Authentication Service Unreachable.");
                console.error(err);
            }
        }

        function showError(msg) {
            document.getElementById('loader').innerHTML = `<h4 class="text-danger">${msg}</h4>`;
        }

        window.onload = runAuth;
    </script>
</body>
</html>
